<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>
        Payment Page
    </title>
    <script src="https://cdn.tailwindcss.com">
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
</head>
<body class="bg-gray-100">
<div class="max-w-4xl mx-auto p-4">
    <div class="flex justify-between items-center mb-4">
        <a class="text-gray-600" href="#">
            <i class="fas fa-arrow-left">
            </i>
            Quay lại
        </a>
        <div class="flex items-center space-x-2">
     <span class="text-gray-600">
      En
     </span>
            <img alt="English flag" class="w-5 h-5" src="https://placehold.co/20x20"/>
        </div>
    </div>
    <div class="bg-white p-6 rounded-lg shadow-lg">
        <div class="flex justify-between items-center mb-6">
            <img alt="VNPAY and VBan logos" class="w-36" src="img/vnpay-logo.png"/>
            <div class="flex items-center space-x-2">

            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-gray-100 p-4 rounded-lg">
                <h2 class="text-lg font-semibold mb-4">
                    Thông tin đơn hàng
                </h2>
                <div class="space-y-2">
                    <div class="flex justify-between">
            <span>
             Số tiền thanh toán
            </span>
                        <span class="text-blue-600 font-semibold">
              <span id="priceAmount">0</span>
              <span class="text-sm">
               VND
              </span>
            </span>
                    </div>
                    <div class="flex justify-between">
            <span>
             Giá trị đơn hàng
            </span>
                        <span>
              <span id="priceAmount2">0</span>
              <span class="text-sm">
               VND
              </span>
            </span>
                    </div>
                    <div class="flex justify-between">
            <span>
             Phí giao dịch
            </span>
                        <span>
             0
             <span class="text-sm">
              VND
             </span>
            </span>
                    </div>
                    <div class="flex justify-between">
            <span>
             Mã đơn hàng
            </span>
                        <span id="orderIdDisplay">
             243686
            </span>
                    </div>
                    <div class="flex justify-between">
            <span>
             Nhà cung cấp
            </span>
                        <span>
             MC CTT VNPAY
            </span>
                    </div>
                    <div id="vaccineInfoContainer"></div>
                </div>
            </div>
            <div>
                <h2 class="text-lg font-semibold mb-4">
                    Thanh toán qua Ngân hàng
                </h2>
                <div class="border-b border-gray-300 mb-4">
                    <ul class="flex space-x-4">
                        <li class="border-b-2 border-blue-600 pb-2">
                            Thẻ nội địa
                        </li>
                        <li class="pb-2">
                            Internet Banking
                        </li>
                    </ul>
                </div>
                <!-- Form thanh toán -->
                <form id="paymentForm">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700" for="card-number">
                                Số thẻ
                            </label>
                            <input class="w-full border border-gray-300 p-2 rounded-md" id="card-number" placeholder="Nhập số thẻ" type="text"/>
                        </div>
                        <div>
                            <label class="block text-gray-700" for="card-name">
                                Tên chủ thẻ
                            </label>
                            <input class="w-full border border-gray-300 p-2 rounded-md" id="card-name" placeholder="Nhập tên chủ thẻ (không dấu)" type="text"/>
                        </div>
                        <div>
                            <label class="block text-gray-700" for="expiry-date">
                                Ngày phát hành
                                <i class="fas fa-info-circle text-gray-400"></i>
                            </label>
                            <input class="w-full border border-gray-300 p-2 rounded-md" id="expiry-date" placeholder="MM/YY" type="text"/>
                        </div>
                    </div>
                    <div class="mt-4">
                        <a class="text-blue-600" href="#">Điều kiện sử dụng dịch vụ</a>
                    </div>
                    <div class="flex justify-between items-center mt-6">
                        <button class="bg-gray-200 px-4 py-2 rounded-md" type="button" id="cancelButton">
                            Hủy thanh toán
                        </button>
                        <button class="bg-blue-600 text-white px-4 py-2 rounded-md" type="submit">
                            Tiếp tục
                        </button>
                    </div>
                </form>

                <div id="countdownContainer" class="flex items-center my-4 justify-center"></div>

                <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        // Lấy thông tin từ URL parameters
                        const urlParams = new URLSearchParams(window.location.search);
                        const bookingId = urlParams.get('bookingId');
                        const vaccineId = urlParams.get('vaccineId');
                        let vaccinePrice = 0;

                        // Hiển thị ID đơn hàng
                        const orderIdElement = document.getElementById('orderIdDisplay');
                        if (orderIdElement && bookingId) {
                            orderIdElement.textContent = bookingId;
                        }

                        // Tạo countdown timer
                        const countdownContainer = document.getElementById('countdownContainer');
                        let minutes = 14;
                        let seconds = 59;

                        countdownContainer.innerHTML = `
                    <span class="text-gray-700 mr-2">Thời gian còn lại:</span>
                    <span class="bg-gray-200 px-2 py-1 rounded-md text-gray-800">${String(minutes).padStart(2, '0')}</span>
                    <span class="mx-1">:</span>
                    <span class="bg-gray-200 px-2 py-1 rounded-md text-gray-800">${String(seconds).padStart(2, '0')}</span>
                `;

                        const minutesElement = countdownContainer.querySelector('.bg-gray-200.px-2.py-1.rounded-md.text-gray-800:nth-child(2)');
                        const secondsElement = countdownContainer.querySelector('.bg-gray-200.px-2.py-1.rounded-md.text-gray-800:nth-child(4)');

                        // Hàm cập nhật giá tiền trên giao diện
                        function updatePriceDisplay(price) {
                            // Định dạng số theo kiểu hiển thị tiền (VD: 15.000)
                            const formattedPrice = Number(price).toLocaleString('vi-VN');

                            // Cập nhật tất cả các phần tử hiển thị giá
                            const priceElements = document.querySelectorAll('#priceAmount, #priceAmount2');
                            priceElements.forEach(element => {
                                element.textContent = formattedPrice;
                            });

                            vaccinePrice = price; // Lưu giá lại để sử dụng khi thanh toán
                        }

                        // Lấy thông tin vaccine và hiển thị giá
                        if (vaccineId) {
                            // Gọi API để lấy thông tin vaccine dựa vào vaccineId
                            fetch(`/vaccine/${vaccineId}`)
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error("Không lấy được thông tin vaccine");
                                    }
                                    return response.json();
                                })
                                .then(data => {
                                    // Cập nhật giá vaccine trên giao diện
                                    updatePriceDisplay(data.price);

                                    // Hiển thị thông tin vaccine
                                    const vaccineInfoElement = document.createElement('div');
                                    vaccineInfoElement.className = 'flex justify-between mt-2';
                                    vaccineInfoElement.innerHTML = `
                                <span>Vaccine:</span>
                                <span>${data.name}</span>
                            `;

                                    // Thêm thông tin vaccine vào phần thông tin đơn hàng
                                    const vaccineInfoContainer = document.getElementById('vaccineInfoContainer');
                                    if (vaccineInfoContainer) {
                                        vaccineInfoContainer.appendChild(vaccineInfoElement);
                                    }
                                })
                                .catch(error => {
                                    console.error("Error fetching vaccine price:", error);

                                    // Nếu không lấy được từ API, thử lấy từ localStorage
                                    const savedVaccineId = localStorage.getItem('selectedVaccineId');
                                    const savedVaccineName = localStorage.getItem('selectedVaccineName');
                                    const savedVaccinePrice = localStorage.getItem('selectedVaccinePrice');

                                    if (savedVaccineId && savedVaccineId === vaccineId) {
                                        // Nếu có tên vaccine trong localStorage thì hiển thị
                                        if (savedVaccineName) {
                                            const vaccineInfoElement = document.createElement('div');
                                            vaccineInfoElement.className = 'flex justify-between mt-2';
                                            vaccineInfoElement.innerHTML = `
                                        <span>Vaccine:</span>
                                        <span>${savedVaccineName}</span>
                                    `;

                                            const vaccineInfoContainer = document.getElementById('vaccineInfoContainer');
                                            if (vaccineInfoContainer) {
                                                vaccineInfoContainer.appendChild(vaccineInfoElement);
                                            }
                                        }

                                        // Cập nhật giá từ localStorage nếu có
                                        if (savedVaccinePrice) {
                                            updatePriceDisplay(savedVaccinePrice);
                                        } else {
                                            // Giá mặc định nếu không có giá trong localStorage
                                            updatePriceDisplay(150000);
                                        }
                                    } else {
                                        // Hiển thị giá mặc định nếu không có thông tin
                                        updatePriceDisplay(150000);
                                    }
                                });
                        } else {
                            // Hiển thị giá mặc định nếu không có vaccineId
                            updatePriceDisplay(150000);
                        }

                        // Khởi động countdown timer
                        const countdownInterval = setInterval(function() {
                            seconds--;
                            if (seconds < 0) {
                                seconds = 59;
                                minutes--;
                            }

                            if (minutes < 0) {
                                clearInterval(countdownInterval);
                                alert('Phiên thanh toán đã hết hạn. Vui lòng đặt lịch lại.');
                                window.location.href = '/datlichtiem';
                                return;
                            }

                            minutesElement.textContent = String(minutes).padStart(2, '0');
                            secondsElement.textContent = String(seconds).padStart(2, '0');
                        }, 1000);

                        // Xử lý form thanh toán
                        const paymentForm = document.getElementById('paymentForm');

                        if (paymentForm) {
                            paymentForm.addEventListener('submit', function(e) {
                                e.preventDefault();

                                const cardNumber = document.getElementById('card-number').value;
                                const cardName = document.getElementById('card-name').value;
                                const expiryDate = document.getElementById('expiry-date').value;

                                // Kiểm tra thông tin đầu vào
                                if (!cardNumber || !cardName || !expiryDate) {
                                    alert('Vui lòng điền đầy đủ thông tin thẻ của bạn');
                                    return;
                                }

                                // Mô phỏng kiểm tra thông tin thẻ ngân hàng
                                const validCards = [
                                    { number: '9704123456789012', name: 'NGUYEN VAN A', expiry: '12/25' },
                                    { number: '9704223344556677', name: 'TRAN THI B', expiry: '05/26' }
                                ];

                                const isValidCard = validCards.some(card =>
                                    card.number === cardNumber &&
                                    card.name === cardName &&
                                    card.expiry === expiryDate
                                );

                                // Lấy giá hiển thị trên giao diện nếu cần
                                if (!vaccinePrice) {
                                    const priceElement = document.getElementById('priceAmount');
                                    if (priceElement) {
                                        // Chuyển đổi chuỗi định dạng (ví dụ: "15.000") thành số
                                        vaccinePrice = parseFloat(priceElement.textContent.replace(/\./g, '').replace(/,/g, '.'));
                                    }
                                }

                                // Gửi thông tin thanh toán đến server
                                fetch('/payment/process', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        bookingId: bookingId,
                                        cardNumber: cardNumber,
                                        cardName: cardName,
                                        expiryDate: expiryDate,
                                        amount: vaccinePrice || 150000 // Sử dụng giá đã lưu hoặc giá mặc định
                                    })
                                })
                                    .then(response => {
                                        if (!response.ok) {
                                            return response.json().then(data => {
                                                throw new Error(data.error || 'Thanh toán thất bại');
                                            });
                                        }
                                        return response.json();
                                    })
                                    .then(data => {
                                        // Hiển thị thông báo thành công
                                        alert('Thanh toán thành công! Cảm ơn bạn đã sử dụng dịch vụ của chúng tôi.');

                                        // Xóa dữ liệu vaccine đã lưu trong localStorage
                                        localStorage.removeItem('selectedVaccineId');
                                        localStorage.removeItem('selectedVaccineName');
                                        localStorage.removeItem('selectedVaccinePrice');

                                        // Sau 2 giây, chuyển hướng về trang chủ
                                        setTimeout(function() {
                                            window.location.href = '/';
                                        }, 2000);
                                    })
                                    .catch(error => {
                                        alert('Thanh toán thất bại: ' + error.message + '. Vui lòng kiểm tra lại thông tin thẻ của bạn.');
                                    });
                            });
                        }

                        // Xử lý nút hủy thanh toán
                        const cancelButton = document.getElementById('cancelButton');
                        if (cancelButton) {
                            cancelButton.addEventListener('click', function() {
                                if (confirm('Bạn có chắc chắn muốn hủy thanh toán? Lịch tiêm của bạn sẽ bị hủy.')) {
                                    // Gửi yêu cầu hủy đặt lịch
                                    fetch('/datlichtiem/cancel/' + bookingId, {
                                        method: 'POST'
                                    })
                                        .then(response => {
                                            if (!response.ok) {
                                                throw new Error('Không thể hủy đặt lịch');
                                            }
                                            return response.json();
                                        })
                                        .then(() => {
                                            alert('Đã hủy đặt lịch tiêm.');

                                            // Xóa dữ liệu vaccine đã lưu trong localStorage
                                            localStorage.removeItem('selectedVaccineId');
                                            localStorage.removeItem('selectedVaccineName');
                                            localStorage.removeItem('selectedVaccinePrice');

                                            window.location.href = '/';
                                        })
                                        .catch(error => {
                                            console.error('Error:', error);
                                            alert('Có lỗi xảy ra khi hủy đặt lịch. Vui lòng thử lại.');
                                        });
                                }
                            });
                        }
                    });
                </script>
            </div>
        </div>
        <div class="flex justify-between items-center mt-6">
            <div class="flex space-x-4">
                <a class="flex items-center space-x-2 text-blue-600" href="tel:1900555577">
                    <i class="fas fa-phone-alt">
                    </i>
                    <span>
        1900.5555.77
       </span>
                </a>
                <a class="flex items-center space-x-2 text-blue-600" href="mailto:hotrovnpay@vnpay.vn">
                    <i class="fas fa-envelope">
                    </i>
                    <span>
        hotrovnpay@vnpay.vn
       </span>
                </a>
            </div>
            <div class="flex space-x-4">
              
            </div>
        </div>
    </div>
</div>
</body>
</html>