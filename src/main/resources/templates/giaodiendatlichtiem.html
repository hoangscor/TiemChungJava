<!DOCTYPE html>
<html  xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Đặt Lịch Tiêm Chủng - Bệnh Viện [Hoàng Ngọc Lạc]</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 700px;
            margin: 40px auto;
            padding: 30px;
            background-color: #f8f9fa; /* Light gray background */
            color: #495057; /* Dark gray text */
            line-height: 1.6;
        }
        .booking-form {
            background-color: #fff;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef; /* Light gray border */
        }
        h2 {
            color: #007bff; /* Primary blue color for heading */
            margin-bottom: 30px;
            text-align: center;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #343a40; /* Dark color for labels */
            font-weight: bold;
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="tel"],
        .form-group input[type="email"],
        .form-group input[type="time"],
        .form-group select {
            width: calc(100% - 22px);
            padding: 12px;
            border: 1px solid #ced4da; /* Light border for inputs */
            border-radius: 6px;
            font-size: 1rem;
            color: #495057;
            box-sizing: border-box;
        }
        .form-group input::placeholder {
            color: #6c757d; /* Light gray for placeholders */
        }
        .inline-group {
            display: flex;
            gap: 20px;
        }
        .submit-btn {
            width: 100%;
            padding: 14px;
            background-color: #28a745; /* Success green button */
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: background-color 0.3s ease;
        }
        .submit-btn:hover {
            background-color: #218838; /* Darker green on hover */
        }
        .hospital-info {
            margin-top: 30px;
            padding: 20px;
            background-color: #e9ecef; /* Light background for info */
            border-radius: 8px;
            font-size: 0.9rem;
            color: #6c757d;
            text-align: center;
        }
        .hospital-info p {
            margin-bottom: 10px;
        }
        /* Responsive adjustments */
        @media (max-width: 600px) {
            .inline-group {
                flex-direction: column;
                gap: 10px;
            }
            .booking-form {
                padding: 20px;
            }
            h2 {
                font-size: 1.8rem;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
<div class="booking-form">
    <h2>Đặt Lịch Tiêm Chủng</h2>
    <form id="vaccineForm">
        <div class="form-group">
            <label for="fullName">Họ và Tên <span style="color: red;">*</span></label>
            <input type="text" id="fullName" placeholder="Nhập đầy đủ họ và tên" required>
        </div>

        <div class="inline-group">
            <div class="form-group" style="flex-grow: 1;">
                <label for="gender">Giới Tính <span style="color: red;">*</span></label>
                <select id="gender" required>
                    <option value="">Chọn Giới Tính</option>
                    <option value="MALE">Nam</option>
                    <option value="FEMALE">Nữ</option>
                    <option value="OTHER">Khác</option>
                </select>
            </div>

            <div class="form-group" style="flex-grow: 1;">
                <label for="age">Tuổi <span style="color: red;">*</span></label>
                <input type="number" id="age" min="0" max="120" placeholder="Nhập số tuổi" required>
            </div>
        </div>

        <div class="form-group">
            <label for="phoneNumber">Số Điện Thoại <span style="color: red;">*</span></label>
            <input type="tel" id="phoneNumber" placeholder="Nhập số điện thoại" required>
        </div>

        <div class="form-group">
            <label for="email">Địa chỉ Email <span style="color: red;">*</span></label>
            <input type="email" id="email" placeholder="Nhập địa chỉ email" required>
        </div>

        <div class="form-group">
            <label for="underlyingConditions">Bệnh Nền (nếu có)</label>
            <input type="text" id="underlyingConditions" placeholder="Nhập bệnh nền nếu có">
        </div>

        <div class="form-group">
            <label for="bookingDate">Ngày Tiêm (DD/MM/YYYY) <span style="color: red;">*</span></label>
            <input type="text" id="bookingDate" placeholder="DD/MM/YYYY" maxlength="10" required>
        </div>

        <div class="form-group">
            <label for="bookingTime">Giờ Tiêm <span style="color: red;">*</span></label>
            <input type="time" id="bookingTime" required>
        </div>

        <div class="form-group">
            <label for="vaccineType">Loại Vaccine <span style="color: red;">*</span></label>
            <select id="vaccineType" required>
                <option value="">Chọn Loại Vaccine</option>
                <th:block th:each="vaccine : ${vaccines}">
                    <option th:value="${vaccine.id}" th:text="${vaccine.name}"></option>
                </th:block>
            </select>
        </div>
        <button type="submit" class="submit-btn">Đặt Lịch Tiêm</button>
    </form>
</div>

<div class="hospital-info">
    <p><strong>Lưu ý:</strong> Vui lòng điền đầy đủ thông tin và kiểm tra kỹ trước khi đặt lịch.</p>
    <p>Chúng tôi sẽ liên hệ lại với bạn để xác nhận lịch hẹn trong thời gian sớm nhất.</p>
    <p>Nếu có bất kỳ thắc mắc nào, vui lòng liên hệ số điện thoại: <a href="tel:113">113</a>.</p>
    <p>Xin cảm ơn quý khách đã tin tưởng dịch vụ của Bệnh viện [Lạc Hoàng Ngọc].</p>
</div>

<script>
    function formatDate(inputDate) {
        // Loại bỏ bất kỳ khoảng trắng thừa
        inputDate = inputDate.trim();

        // Tách các phần của ngày
        const parts = inputDate.split('/');

        // Kiểm tra và điều chỉnh định dạng
        if (parts.length !== 3) {
            return null;
        }

        const day = parts[0].padStart(2, '0');
        const month = parts[1].padStart(2, '0');
        let year = parts[2];

        // Xử lý năm 2 số
        if (year.length === 2) {
            year = (parseInt(year) > 50 ? '19' : '20') + year;
        }

        // Kiểm tra tính hợp lệ của ngày
        const formattedDate = `${year}-${month}-${day}`;
        const dateObj = new Date(formattedDate);

        // Validate ngày
        if (isNaN(dateObj.getTime())) {
            return null;
        }

        return {
            dateObj: dateObj,
            formattedDate: formattedDate
        };
    }

    document.getElementById('vaccineForm').addEventListener('submit', function(e) {
        e.preventDefault();

        // Kiểm tra lại ngày đặt lịch trước khi submit
        const bookingDateValue = document.getElementById('bookingDate').value;
        const result = formatDate(bookingDateValue);

        if (result) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (result.dateObj < today) {
                alert('Không thể đặt lịch cho ngày trong quá khứ. Vui lòng chọn ngày hiện tại hoặc tương lai.');
                return;
            }

            // Lấy thông tin vaccine được chọn
            const vaccineSelect = document.getElementById('vaccineType');
            const vaccineId = vaccineSelect.value;
            const vaccineName = vaccineSelect.options[vaccineSelect.selectedIndex].text;

            const booking = {
                fullName: document.getElementById('fullName').value,
                gender: document.getElementById('gender').value,
                age: parseInt(document.getElementById('age').value),
                phoneNumber: document.getElementById('phoneNumber').value,
                email: document.getElementById('email').value,
                bookingDate: result.formattedDate, // Sử dụng định dạng YYYY-MM-DD cho API
                bookingTime: document.getElementById('bookingTime').value,
                vaccineType: vaccineId,
                underlyingConditions: document.getElementById('underlyingConditions').value
            };

            // Lưu thông tin vaccine đã chọn vào localStorage để sử dụng ở trang thanh toán
            localStorage.setItem('selectedVaccineId', vaccineId);
            localStorage.setItem('selectedVaccineName', vaccineName);

            // Thay đổi URL API nếu cần
            fetch('/datlichtiem/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(booking)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    // Chuyển hướng đến trang thanh toán với ID đặt lịch và ID vaccine
                    window.location.href = '/payment?bookingId=' + data.id + '&vaccineId=' + vaccineId;
                })
                .catch(error => {
                    alert('Có lỗi xảy ra khi đặt lịch. Vui lòng thử lại.');
                    console.error('Error:', error);
                });
        } else {
            alert('Ngày không hợp lệ. Vui lòng nhập theo định dạng DD/MM/YYYY');
        }
    });

</script>
</body>
</html>